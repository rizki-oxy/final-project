<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Road Monitoring Database Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .dashboard-container {
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        margin: 20px;
        overflow: hidden;
      }

      .dashboard-header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 25px;
        text-align: center;
      }

      .table-selector {
        background: #f8f9fa;
        padding: 20px;
        border-bottom: 2px solid #dee2e6;
      }

      .table-card {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
      }

      .table-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        border-color: #007bff;
      }

      .table-card.active {
        border-color: #007bff;
        background: #f8f9ff;
      }

      .filters-section {
        background: #f8f9fa;
        padding: 20px;
        border-bottom: 1px solid #dee2e6;
      }

      .data-section {
        padding: 20px;
      }

      .loading-spinner {
        text-align: center;
        padding: 50px;
      }

      .table-responsive {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .badge-custom {
        font-size: 0.85em;
        padding: 0.5em 0.75em;
      }

      .pagination {
        margin-top: 20px;
      }

      .download-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        color: white;
        padding: 10px 20px;
        border-radius: 25px;
        transition: all 0.3s ease;
      }

      .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
      }
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <!-- Header -->
      <div class="dashboard-header">
        <h1>
          <i class="fas fa-database"></i> Road Monitoring Database Dashboard
        </h1>
        <p class="mb-0">Akses dan Download Data Monitoring Jalan</p>
      </div>

      <!-- Table Selector -->
      <div class="table-selector">
        <h4 class="mb-3">Pilih Tabel Database</h4>
        <div class="row" id="table-selector">
          <!-- Table cards will be loaded here -->
        </div>
      </div>

      <!-- Filters -->
      <div class="filters-section" id="filters-section" style="display: none">
        <div class="row">
          <div class="col-md-3">
            <label for="date-from" class="form-label">Dari Tanggal</label>
            <input type="date" class="form-control" id="date-from" />
          </div>
          <div class="col-md-3">
            <label for="date-to" class="form-label">Sampai Tanggal</label>
            <input type="date" class="form-control" id="date-to" />
          </div>
          <div class="col-md-4">
            <label for="search" class="form-label">Pencarian</label>
            <input
              type="text"
              class="form-control"
              id="search"
              placeholder="Ex : Ringan/Sedang/Berat"
            />
          </div>
          <div class="col-md-2">
            <label class="form-label">&nbsp;</label>
            <div class="d-grid">
              <button class="btn btn-primary" onclick="loadTableData()">
                <i class="fas fa-search"></i> Filter
              </button>
            </div>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-12">
            <button class="btn download-btn" onclick="downloadCSV()">
              <i class="fas fa-download"></i> Download CSV
            </button>
            <button
              class="btn btn-outline-secondary ms-2"
              onclick="clearFilters()"
            >
              <i class="fas fa-times"></i> Clear Filters
            </button>
          </div>
        </div>
      </div>

      <!-- Data Section -->
      <div class="data-section">
        <div id="loading" class="loading-spinner" style="display: none">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-3">Memuat data...</p>
        </div>

        <div id="data-content" style="display: none">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 id="table-title">Data Tabel</h4>
            <div>
              <span id="data-info" class="text-muted"
                >Menampilkan 0 dari 0 data</span
              >
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr id="table-header">
                  <!-- Headers will be loaded dynamically -->
                </tr>
              </thead>
              <tbody id="table-body">
                <!-- Data will be loaded here -->
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center" id="pagination">
              <!-- Pagination will be loaded here -->
            </ul>
          </nav>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      let currentTable = null;
      let currentPage = 1;
      let currentFilters = {};

      // Load tables on page load
      document.addEventListener("DOMContentLoaded", function () {
        loadAvailableTables();
      });

      async function loadAvailableTables() {
        try {
          const response = await fetch("/dashboard/api/tables");
          const data = await response.json();

          const container = document.getElementById("table-selector");
          container.innerHTML = "";

          data.tables.forEach((table) => {
            const card = document.createElement("div");
            card.className = "col-md-6";
            card.innerHTML = `
                        <div class="table-card" onclick="selectTable('${table.name}')">
                            <div class="d-flex align-items-center mb-2">
                                <span class="fs-2 me-3">${table.icon}</span>
                                <div>
                                    <h5 class="mb-1">${table.display_name}</h5>
                                    <small class="text-muted">${table.description}</small>
                                </div>
                            </div>
                        </div>
                    `;
            container.appendChild(card);
          });
        } catch (error) {
          console.error("Error loading tables:", error);
        }
      }

      function selectTable(tableName) {
        currentTable = tableName;
        currentPage = 1;

        // Update UI
        document.querySelectorAll(".table-card").forEach((card) => {
          card.classList.remove("active");
        });
        event.target.closest(".table-card").classList.add("active");

        // Show filters
        document.getElementById("filters-section").style.display = "block";

        // Load data
        loadTableData();
      }

      async function loadTableData() {
        if (!currentTable) return;

        // Show loading
        document.getElementById("loading").style.display = "block";
        document.getElementById("data-content").style.display = "none";

        try {
          // Get filter values
          const dateFrom = document.getElementById("date-from").value;
          const dateTo = document.getElementById("date-to").value;
          const search = document.getElementById("search").value;

          // Build query parameters
          const params = new URLSearchParams({
            page: currentPage,
            per_page: 50,
            search: search,
            date_from: dateFrom,
            date_to: dateTo,
          });

          currentFilters = { dateFrom, dateTo, search };

          const response = await fetch(
            `/dashboard/api/data/${currentTable}?${params}`
          );
          const data = await response.json();

          if (data.error) {
            throw new Error(data.error);
          }

          // Update UI
          renderTableData(data);
        } catch (error) {
          console.error("Error loading data:", error);
          alert("Error loading data: " + error.message);
        } finally {
          document.getElementById("loading").style.display = "none";
        }
      }

      function renderTableData(data) {
        const tableTitle = document.getElementById("table-title");
        const dataInfo = document.getElementById("data-info");
        const tableHeader = document.getElementById("table-header");
        const tableBody = document.getElementById("table-body");
        const pagination = document.getElementById("pagination");

        // Update title
        const tableNames = {
          road_damage_analysis: "Analisis Kerusakan Jalan",
          sensor_data: "Data Sensor Mentah",
        };
        tableTitle.textContent = tableNames[currentTable] || currentTable;

        // Update info
        const start = (data.page - 1) * data.per_page + 1;
        const end = Math.min(data.page * data.per_page, data.total);
        dataInfo.textContent = `Menampilkan ${start}-${end} dari ${data.total} data`;

        // Render headers
        if (data.data.length > 0) {
          const headers = Object.keys(data.data[0]);
          tableHeader.innerHTML = headers
            .map(
              (header) => `<th>${header.replace(/_/g, " ").toUpperCase()}</th>`
            )
            .join("");

          // Render data
          tableBody.innerHTML = data.data
            .map((row) => {
              const cells = headers
                .map((header) => {
                  let value = row[header];

                  // Format specific columns
                  if (header === "damage_classification") {
                    const badges = {
                      rusak_ringan: "success",
                      rusak_sedang: "warning",
                      rusak_berat: "danger",
                    };
                    const badgeClass = badges[value] || "secondary";
                    value = `<span class="badge bg-${badgeClass} badge-custom">${value
                      ?.replace("_", " ")
                      .toUpperCase()}</span>`;
                  }

                  return `<td>${value !== null ? value : "-"}</td>`;
                })
                .join("");

              return `<tr>${cells}</tr>`;
            })
            .join("");
        } else {
          tableHeader.innerHTML = "<th>No Data</th>";
          tableBody.innerHTML = "<tr><td>Tidak ada data ditemukan</td></tr>";
        }

        // Render pagination
        renderPagination(data);

        // Show content
        document.getElementById("data-content").style.display = "block";
      }

      function renderPagination(data) {
        const pagination = document.getElementById("pagination");
        let paginationHTML = "";

        // Previous button
        if (data.has_prev) {
          paginationHTML += `<li class="page-item">
                    <a class="page-link" href="#" onclick="changePage(${
                      data.page - 1
                    })">Previous</a>
                </li>`;
        }

        // Page numbers
        const startPage = Math.max(1, data.page - 2);
        const endPage = Math.min(data.total_pages, data.page + 2);

        for (let i = startPage; i <= endPage; i++) {
          const active = i === data.page ? "active" : "";
          paginationHTML += `<li class="page-item ${active}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>`;
        }

        // Next button
        if (data.has_next) {
          paginationHTML += `<li class="page-item">
                    <a class="page-link" href="#" onclick="changePage(${
                      data.page + 1
                    })">Next</a>
                </li>`;
        }

        pagination.innerHTML = paginationHTML;
      }

      function changePage(page) {
        currentPage = page;
        loadTableData();
      }

      function clearFilters() {
        document.getElementById("date-from").value = "";
        document.getElementById("date-to").value = "";
        document.getElementById("search").value = "";
        currentPage = 1;
        loadTableData();
      }

      async function downloadCSV() {
        if (!currentTable) {
          alert("Pilih tabel terlebih dahulu");
          return;
        }

        try {
          // Build query parameters
          const params = new URLSearchParams({
            search: currentFilters.search || "",
            date_from: currentFilters.dateFrom || "",
            date_to: currentFilters.dateTo || "",
          });

          // Create download link
          const downloadUrl = `/dashboard/api/download/${currentTable}?${params}`;

          // Show loading
          const btn = event.target;
          const originalText = btn.innerHTML;
          btn.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Downloading...';
          btn.disabled = true;

          // Trigger download
          window.location.href = downloadUrl;

          // Reset button
          setTimeout(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
          }, 2000);
        } catch (error) {
          console.error("Error downloading:", error);
          alert("Error downloading file: " + error.message);
        }
      }

      // Auto-refresh every 30 seconds
      setInterval(() => {
        if (currentTable) {
          loadTableData();
        }
      }, 30000);
    </script>
  </body>
</html>
'''
